協会けんぽ 保険料額表変換ツール
================

このツールは、全国健康保険協会（協会けんぽ）が提供している[保険料額表](https://www.kyoukaikenpo.or.jp/g3/cat330/)をプログラムから利用しやすくするための変換ツールです。  
協会けんぽは日本最大の医療保険者であり、国民皆保険の原則による徴税的性質が強い制度であるため、本来は国の電子政府活動の一貫として、プログラムから処理できるデータフォーマットやAPIが提供されるべきものです。

しかし、現状は人が目視で運用するためのExcelフォーマットしか提供されていないため、リファレンス実装としてオープンソースのツールを作成しました。

データ形式は、多くのプログラミング言語ライブラリでサポートされている、JSONとYAMLの２つの形式で出力します。データ構造は独自に定義しています。各プログラムにロードして用途に沿って組み替えることは簡単でしょう。


データフォーマット
------------

* area
  * テーブル適用対象の都道府県
* effective_date
  * テーブルの発効年月（YYYY-mm-dd）
* fee
  * 等級別の保険料額表

feeの各アイテムは以下のようなデータを持ちます。

* rank
  * 健康保険の等級
* pension_rank
  * 年金の等級
* label
  * 等級のラベル文字列
* rank_min
  * 等級に属する最低金額
* rank_max
  * 等級に属する最高金額
* insurance_younger_total
  * 健康保険料（総額）。介護保険料に該当しない者
* insurance_younger_total
  * 健康保険料（本人負担）。介護保険料に該当しない者
* insurance_elder_total
  * 健康保険料（総額）。介護保険料に該当する者
* insurance_elder_salary
  * 健康保険料（本人負担）。介護保険料に該当する者
* pension_total
  * 年金保険料（総額）
* nension_salary
  * 年金保険料（本人負担）

なお保険料額の数値は文字列型としています。これは保険料額が少数であり、float型として解釈されると計算結果に影響が出ることを考慮したものです。


ツール動作環境
------------

* Excel→CSV変換ツール
  * rubyの[roo](https://github.com/roo-rb/roo) gemライブラリが必要
* CSV→JSON/YAML変換ツール
  * rubyの標準ライブラリのみで動作


実行方法
------------

コマンドライン実行します。

Excel→CSV変換ツールは、以下のとおりExcelファイルを指定すると県別のCSVを生成します。

```
$ ruby lib/xlsx2csv.rb Excelファイル名
```

CSV→JSON/YAML変換ツールは、以下のとおりディレクトリを指定すると県別のCSVからJSONとYAMLを生成します。
また発効日付は、保険料額の適用開始月を`2020/4/1`といった文字列で指定します。なお、年と月のみ反映され、日は利用していません。

```
$ ruby lib/csv2dat.rb CSVファイルのあるディレクトリ 発効日付
```


制約事項
------------

* Excelフォーマットが変更されると、使用できなくなる可能性があります。手作業のためのファイルをプログラム処理用に変換することには限界があり、協会けんぽからJSONやYAML形式で一次配布されることが重要です
* CSVファイルはfloat型の数値になっているため、元の金額と一致しておらず、少数点２位以下で微妙な差が出ています。rooに評価オプションがないため手軽に対応する手段がありません。CSVからJSON/YAMLに変換する際に再変換しています

